# Gazebo Web 可视化方案

## 方案概述

本方案提供了一个适合前端程序员的 Gazebo Web 可视化解决方案，通过浏览器直接访问和控制 Gazebo 仿真环境。

### 核心特点

- ✅ **最简单** - 基于 noVNC + FastAPI，技术栈成熟稳定
- ✅ **能定制** - 前后端分离，界面完全自定义
- ✅ **适合前端** - RESTful API，无需学习 ROS 2 复杂概念
- ✅ **跨平台** - 浏览器访问，支持移动设备
- ✅ **零安装** - 客户端无需安装任何软件

---

## 架构设计

```
┌─────────────────┐      HTTP/WebSocket      ┌──────────────────┐
│                 │ ◄───────────────────────► │                  │
│  前端界面       │                            │   FastAPI 后端   │
│  (HTML/JS/CSS)  │                            │   (Python)       │
│                 │                            │                  │
└─────────────────┘                            └──────────────────┘
                                                        │
                                                        │ 进程控制
                                                        ▼
                                    ┌──────────────────────────────┐
                                    │                              │
                                    │  noVNC ◄─► X11vnc ◄─► Gazebo│
                                    │                              │
                                    │  ROS 2 节点 (talker/listener)│
                                    │                              │
                                    └──────────────────────────────┘
```

### 技术栈

| 层级 | 技术 | 作用 |
|------|------|------|
| **前端** | HTML/CSS/JavaScript | 用户界面和交互 |
| **后端** | FastAPI + Uvicorn | RESTful API 服务 |
| **显示** | noVNC + x11vnc | Gazebo 画面传输 |
| **仿真** | Gazebo + ROS 2 | 机器人仿真环境 |

---

## 安装依赖

### 系统依赖

```bash
# 安装 VNC 和 noVNC
sudo apt install x11vnc novnc websockify -y

# 安装 Gazebo（如果未安装）
sudo apt install gazebo ros-humble-gazebo-ros-pkgs -y
```

### Python 依赖

```bash
# 安装 FastAPI 和相关库
pip3 install fastapi uvicorn websockets
```

---

## 文件结构

```
/home/leju/zdc/myros/
├── gazebo_web_api.py           # 后端 API 服务
├── start_web_server.sh         # 启动脚本
├── web/
│   └── index.html              # 前端界面
├── py_pubsub/                  # ROS 2 示例包
│   └── py_pubsub/
│       ├── publisher_member_function.py
│       └── subscriber_member_function.py
└── GAZEBO_WEB_SOLUTION.md      # 本文档
```

---

## 后端 API 接口

### 1. Gazebo 控制

#### 启动 Gazebo
```http
POST /gazebo/start
```

**响应示例：**
```json
{
  "status": "success",
  "message": "Gazebo 已启动",
  "vnc_url": "http://localhost:6080/vnc.html"
}
```

#### 停止 Gazebo
```http
POST /gazebo/stop
```

**响应示例：**
```json
{
  "status": "success",
  "stopped": ["vnc", "novnc", "gazebo"]
}
```

#### 查看状态
```http
GET /gazebo/status
```

**响应示例：**
```json
{
  "gazebo_running": true,
  "vnc_running": true,
  "novnc_running": true
}
```

### 2. ROS 2 控制

#### 发布消息
```http
POST /ros2/publish?topic=/topic&message=Hello
```

**响应示例：**
```json
{
  "status": "success",
  "message": "已发布到 /topic"
}
```

#### 列出话题
```http
GET /ros2/topics
```

**响应示例：**
```json
{
  "status": "success",
  "topics": ["/topic", "/rosout", "/parameter_events"]
}
```

---

## 使用指南

### 启动服务

```bash
# 方式一：使用启动脚本（推荐）
cd /home/leju/zdc/myros
./start_web_server.sh

# 方式二：手动启动
# 终端 1 - 启动后端 API
python3 gazebo_web_api.py

# 终端 2 - 启动前端服务器
cd web
python3 -m http.server 3000
```

### 访问界面

- **前端控制台**: http://localhost:3000
- **API 文档**: http://localhost:8000/docs
- **直接访问 VNC**: http://localhost:6080/vnc.html

### 操作流程

1. 打开浏览器访问 `http://localhost:3000`
2. 点击 "▶️ 启动 Gazebo" 按钮
3. 等待 2-3 秒，Gazebo 界面会显示在右侧区域
4. 使用左侧控制面板：
   - 启动/停止 Gazebo
   - 发布 ROS 2 消息
   - 查看话题列表
   - 检查运行状态

---

## 前端开发指南

### 调用 API 示例

```javascript
// 启动 Gazebo
async function startGazebo() {
    const response = await fetch('http://localhost:8000/gazebo/start', {
        method: 'POST'
    });
    const data = await response.json();
    console.log(data);
}

// 发布消息
async function publishMessage(topic, message) {
    const url = `http://localhost:8000/ros2/publish?topic=${topic}&message=${message}`;
    const response = await fetch(url, { method: 'POST' });
    const data = await response.json();
    console.log(data);
}

// 获取话题列表
async function getTopics() {
    const response = await fetch('http://localhost:8000/ros2/topics');
    const data = await response.json();
    console.log(data.topics);
}
```

### 自定义界面

前端界面完全可定制，你可以：

1. **修改样式** - 编辑 CSS 部分
2. **添加功能** - 增加按钮和 API 调用
3. **集成框架** - 使用 React/Vue/Angular
4. **添加图表** - 使用 Chart.js/ECharts 可视化数据
5. **移动适配** - 响应式布局

---

## 扩展功能

### 1. 添加新的 API 接口

在 `gazebo_web_api.py` 中添加：

```python
@app.post("/robot/move")
async def move_robot(direction: str, speed: float):
    """控制机器人移动。"""
    # 实现机器人控制逻辑
    return {"status": "success"}
```

### 2. 集成数据库

```python
from sqlalchemy import create_engine
from fastapi import Depends

# 记录仿真历史
@app.post("/simulation/save")
async def save_simulation(name: str):
    # 保存到数据库
    pass
```

### 3. 添加用户认证

```python
from fastapi.security import HTTPBasic, HTTPBasicCredentials

security = HTTPBasic()

@app.get("/protected")
async def protected_route(credentials: HTTPBasicCredentials = Depends(security)):
    # 验证用户
    pass
```

### 4. WebSocket 实时通信

```python
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    while True:
        # 实时推送 ROS 2 话题数据
        data = await get_ros_data()
        await websocket.send_json(data)
```

---

## 性能优化

### 1. 降低延迟

```bash
# 使用 TurboVNC 替代 x11vnc（性能更好）
sudo apt install turbovnc
vncserver :1
websockify 6080 localhost:5901
```

### 2. 压缩传输

```python
# 在 API 中启用 gzip 压缩
from fastapi.middleware.gzip import GZipMiddleware
app.add_middleware(GZipMiddleware, minimum_size=1000)
```

### 3. 缓存优化

```python
from functools import lru_cache

@lru_cache(maxsize=100)
def get_cached_topics():
    # 缓存话题列表
    pass
```

---

## 故障排查

### 问题 1: Gazebo 无法启动

**症状**: 点击启动按钮没有反应

**解决方案**:
```bash
# 检查 DISPLAY 环境变量
echo $DISPLAY

# 手动测试 Gazebo
DISPLAY=:0 gazebo

# 检查 X11 权限
xhost +local:
```

### 问题 2: VNC 连接失败

**症状**: 浏览器显示连接失败

**解决方案**:
```bash
# 检查 VNC 服务是否运行
ps aux | grep x11vnc

# 检查端口占用
netstat -tuln | grep 5900
netstat -tuln | grep 6080

# 重启 VNC
pkill x11vnc
x11vnc -display :0 -forever -shared -rfbport 5900
```

### 问题 3: API 跨域错误

**症状**: 浏览器控制台显示 CORS 错误

**解决方案**: 已在代码中配置 CORS，如需限制来源：
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # 只允许特定来源
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 问题 4: ROS 2 命令找不到

**症状**: API 返回 "command not found"

**解决方案**:
```bash
# 在启动脚本中添加环境变量
source /opt/ros/humble/setup.bash
source /home/leju/zdc/myros/install/setup.bash
```

---

## 安全建议

### 生产环境部署

1. **启用 HTTPS**
```bash
# 使用 Nginx 反向代理
sudo apt install nginx
# 配置 SSL 证书
```

2. **添加认证**
```python
from fastapi.security import OAuth2PasswordBearer
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")
```

3. **限制访问**
```python
# 限制 IP 访问
from fastapi import Request, HTTPException

@app.middleware("http")
async def validate_ip(request: Request, call_next):
    if request.client.host not in allowed_ips:
        raise HTTPException(status_code=403)
    return await call_next(request)
```

4. **防火墙配置**
```bash
# 只允许本地访问
sudo ufw allow from 127.0.0.1 to any port 8000
sudo ufw allow from 127.0.0.1 to any port 6080
```

---

## 对比其他方案

| 方案 | 复杂度 | 性能 | 可定制性 | 适合人群 |
|------|--------|------|----------|----------|
| **本方案 (noVNC+API)** | ⭐ 低 | ⭐⭐⭐ 中 | ⭐⭐⭐⭐⭐ 很高 | 前端程序员 |
| Gzweb | ⭐⭐ 中 | ⭐⭐⭐ 中 | ⭐⭐ 低 | 快速演示 |
| Xpra | ⭐⭐⭐ 高 | ⭐⭐⭐⭐ 高 | ⭐⭐⭐ 中 | 性能要求高 |
| 自定义 WebRTC | ⭐⭐⭐⭐⭐ 很高 | ⭐⭐⭐⭐⭐ 很高 | ⭐⭐⭐⭐⭐ 很高 | 专业团队 |
| 云渲染 (NICE DCV) | ⭐⭐⭐⭐ 高 | ⭐⭐⭐⭐⭐ 很高 | ⭐⭐ 低 | 企业级应用 |

---

## 未来改进方向

### 短期 (1-2 周)
- [ ] 添加用户认证系统
- [ ] 实现 WebSocket 实时数据推送
- [ ] 添加仿真历史记录功能
- [ ] 移动端界面优化

### 中期 (1-2 月)
- [ ] 集成机器人控制面板
- [ ] 添加传感器数据可视化
- [ ] 实现多用户协作
- [ ] 性能监控和日志系统

### 长期 (3-6 月)
- [ ] 迁移到 WebRTC 降低延迟
- [ ] 支持多个 Gazebo 实例
- [ ] 云端部署和负载均衡
- [ ] AI 辅助调试功能

---

## 参考资源

- [FastAPI 官方文档](https://fastapi.tiangolo.com/)
- [noVNC GitHub](https://github.com/novnc/noVNC)
- [ROS 2 Humble 文档](https://docs.ros.org/en/humble/)
- [Gazebo 官方网站](https://gazebosim.org/)

---

## 许可证

本方案基于 Apache License 2.0 开源。

---

## 联系方式

- 作者: oimo
- 项目路径: `/home/leju/zdc/myros`
- 创建时间: 2026年1月7日

---

**最后更新**: 2026年1月7日